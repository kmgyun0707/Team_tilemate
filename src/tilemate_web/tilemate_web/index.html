<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>TILING MONITOR - ë‘ì‚° M0609</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #f0f2f5; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        header { border-bottom: 3px solid #1a237e; margin-bottom: 25px; padding-bottom: 10px; text-align: center; }
        h1 { font-size: 42px; color: #1a237e; margin: 0; letter-spacing: 2px; }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .info-item { font-size: 1.1em; font-weight: bold; }
        .info-item span { color: #d32f2f; }
        
        #timer-container { grid-column: span 2; text-align: center; font-size: 1.5em; background: #eee; padding: 5px; border-radius: 5px; margin-bottom: 10px; }

        .control-panel { display: flex; gap: 15px; margin-bottom: 30px; }
        button { flex: 1; padding: 20px; font-size: 1.5em; font-weight: bold; border: none; border-radius: 10px; cursor: pointer; transition: 0.3s; }
        #btn-start { background-color: #e8f5e9; color: #2e7d32; border: 2px solid #2e7d32; }
        #btn-pause { background-color: #fff3e0; color: #ef6c00; border: 2px solid #ef6c00; }
        #btn-reset { background-color: #ffebee; color: #c62828; border: 2px solid #c62828; }

        .process-flow { display: flex; justify-content: space-between; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 25px; }
        .step { font-weight: bold; color: #999; font-size: 1.1em; padding: 5px 15px; border-radius: 20px; }
        .step.active { background-color: #ff0000; color: #ffffff !important; box-shadow: 0 0 10px rgba(255,0,0,0.5); }

        .bottom-section { display: flex; gap: 20px; align-items: stretch; }
        
        /* 3x3 ê·¸ë¦¬ë“œ */
        .tile-grid-wrapper {
            flex: 1.5;
            display: flex;
            flex-direction: column;
        }
        .tile-grid { 
            flex: 1;
            display: grid; 
            grid-template-columns: repeat(3, 1fr);
            gap: 10px; 
            background: #e9ecef; 
            padding: 15px; 
            border-radius: 12px; 
            border: 1px solid #ccc;
            align-content: center;
        }
        .tile { 
            aspect-ratio: 1 / 1;
            background-color: #ffffff; 
            border: 2px solid #ddd; 
            border-radius: 6px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.05em; 
            font-weight: bold; 
            color: #555; 
            transition: all 0.4s ease; 
        }

        .tile.coated   { background-color: #9e9e9e; border-color: #757575; color: white; }
        .tile.working  { background-color: #ffc107; border-color: #ff9800; color: white; }
        .tile.running  { background-color: #4caf50; border-color: #2e7d32; color: white; }
        .tile.finished { background-color: #1a237e; border-color: #0d124a; color: white; }
        
        #three-container { width: 100%; height: 450px; background: #f8f9fa; border-radius: 12px; border: 1px solid #ccc; }

        /* â”€â”€ ë””ìì¸ ì„ íƒ íŒì—… â”€â”€ */
        .popup-overlay {
            display: none;
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.55);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .popup-overlay.show { display: flex; }
        .popup-box {
            background: white;
            border-radius: 16px;
            padding: 32px 36px;
            width: 720px;
            max-width: 95vw;
            box-shadow: 0 8px 40px rgba(0,0,0,0.25);
        }
        .popup-box h2 { text-align: center; color: #1a237e; margin: 0 0 24px; font-size: 1.5em; }
        .design-options { display: flex; gap: 18px; justify-content: center; }
        .design-card {
            flex: 1; border: 3px solid #ddd; border-radius: 12px;
            padding: 16px 12px; cursor: pointer; text-align: center;
            transition: 0.2s; background: #fafafa;
        }
        .design-card:hover { border-color: #1a237e; background: #e8eaf6; }
        .design-card.selected { border-color: #1a237e; background: #e8eaf6; }
        .design-card p { margin: 10px 0 0; font-weight: bold; font-size: 0.95em; color: #333; }
        .design-card small { color: #777; font-size: 0.8em; }
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(3, 28px);
            grid-template-rows: repeat(3, 28px);
            gap: 3px;
            margin: 0 auto 8px;
            width: fit-content;
        }
        .preview-cell {
            width: 28px; height: 28px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .pc-black { background: #212121; border-color: #000; }
        .popup-confirm {
            display: block; margin: 24px auto 0;
            padding: 14px 48px; font-size: 1.2em; font-weight: bold;
            background: #1a237e; color: white; border: none;
            border-radius: 10px; cursor: pointer; flex: unset;
        }
        .popup-confirm:hover { background: #283593; }
        .popup-cancel {
            display: block; margin: 10px auto 0;
            padding: 8px 32px; font-size: 0.95em; font-weight: bold;
            background: transparent; color: #999; border: 1px solid #ddd;
            border-radius: 8px; cursor: pointer; flex: unset;
        }

        @keyframes blink-estop {
            0%, 100% { opacity: 1; }
            50%       { opacity: 0.4; }
        }
    </style>
</head>
<body>

<div class="container">
    <header><h1>TILING MONITOR</h1></header>

    <div class="info-grid">
        <div id="timer-container">íƒ€ì¼ë§ ì‹œê°„: <span id="timer">00 : 00 : 00</span></div>
        <div class="info-item">íƒ€ì¼ë§ ì§„í–‰ë„: <span id="job-count">0</span> / <span id="total-tiles">9</span></div>
        <div class="info-item" style="text-align: right;">ë¡œë´‡ì†ë„: <span id="robot-speed">0.000</span> m/s</div>
        <div class="info-item">íˆ´ ì™¸ë ¥ Fz: <span id="force-z">0.00</span> N &nbsp;|&nbsp; í•©ë ¥: <span id="force-total">0.00</span> N</div>
        <div class="info-item" style="text-align: right;">ìƒíƒœ: <span id="robot-state">ëŒ€ê¸°</span></div>
        <div class="info-item" colspan="2" style="grid-column: span 2;">
            <div style="margin-top: 4px;">
                <span style="font-size:0.95em; color:#333;">ê´€ì ˆ ì™¸ë¶€í† í¬ (Nm): </span>
                <span id="ext-torque-display" style="color:#d32f2f; font-size:0.95em;">J1: 0.00 &nbsp; J2: 0.00 &nbsp; J3: 0.00 &nbsp; J4: 0.00 &nbsp; J5: 0.00 &nbsp; J6: 0.00</span>
            </div>
        </div>
    </div>

    <div class="control-panel">
        <button id="btn-start" onclick="openDesignPopup()">ì‹œì‘</button>
        <button id="btn-pause" onclick="sendCommand('stop')">ì¼ì‹œì •ì§€</button>
        <button id="btn-reset" onclick="resetSystem()">ì´ˆê¸°í™”</button>
    </div>

    <div class="process-flow">
        <div id="step1" class="step">ì ‘ì°©ì œ íŒŒì§€</div>
        <div class="step">â†’</div>
        <div id="step2" class="step">ì ‘ì°©ì œ ë„í¬</div>
        <div class="step">â†’</div>
        <div id="step3" class="step">íƒ€ì¼ íŒŒì§€</div>
        <div class="step">â†’</div>
        <div id="step4" class="step">íƒ€ì¼ ë°°ì¹˜</div>
    </div>

    <div class="bottom-section" id="bottom-section" style="position: relative;">

        <!-- ë¹„ìƒì •ì§€ ì˜¤ë²„ë ˆì´ -->
        <div id="estop-overlay" style="
            display: none;
            position: absolute; inset: 0;
            z-index: 100;
            border: 6px solid #c62828;
            border-radius: 12px;
            background: rgba(198, 40, 40, 0.13);
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 18px;
            pointer-events: none;
        ">
            <div style="
                background: #c62828;
                color: white;
                font-size: 2em;
                font-weight: bold;
                letter-spacing: 4px;
                padding: 12px 36px;
                border-radius: 10px;
                box-shadow: 0 4px 20px rgba(198,40,40,0.5);
                animation: blink-estop 1s step-start infinite;
            ">â›” ë¹„ìƒì •ì§€</div>
            <div id="collision-info" style="
                display: none;
                background: #fff3e0;
                color: #bf360c;
                font-size: 1em;
                font-weight: bold;
                padding: 8px 24px;
                border-radius: 8px;
                border: 2px solid #ff6d00;
            "></div>
            <div id="collision-reset-guide" style="
                display: none;
                color: #ffffff;
                font-size: 1em;
                font-weight: bold;
                background: rgba(0,0,0,0.4);
                padding: 8px 20px;
                border-radius: 8px;
            ">ì¶©ëŒ ì›ì¸ ì œê±° í›„ ì¬ê°œë²„íŠ¼ì´ë‚˜ ì´ˆê¸°í™” ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</div>
            <button id="resume-btn" onclick="resumeRobot()" style="
                pointer-events: all;
                padding: 14px 44px;
                font-size: 1.3em;
                font-weight: bold;
                background: #ffffff;
                color: #c62828;
                border: 3px solid #c62828;
                border-radius: 10px;
                cursor: pointer;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                transition: 0.2s;
                flex: unset;
            " onmouseover="this.style.background='#ffebee'" onmouseout="this.style.background='#ffffff'">
                â–¶ ì¬ê°œ
            </button>
        </div>

        <div class="tile-grid-wrapper">
            <div class="tile-grid" id="tile-map"></div>
            <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; display: flex; gap: 20px; justify-content: center; font-size: 0.95em; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #9e9e9e; border: 2px solid #757575; border-radius: 4px;"></div>
                    <span>ë„í¬ì™„ë£Œ</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #ffc107; border: 2px solid #ff9800; border-radius: 4px;"></div>
                    <span>ì‘ì—…ì¤‘</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #4caf50; border: 2px solid #2e7d32; border-radius: 4px;"></div>
                    <span>ë§ˆë¥´ëŠ”ì¤‘</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #1a237e; border: 2px solid #0d124a; border-radius: 4px;"></div>
                    <span>ì™„ë£Œ</span>
                </div>

                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #212121; border: 2px solid #000; border-radius: 4px;"></div>
                    <span>ê²€ì •íƒ€ì¼</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #ffffff; border: 2px solid #ccc; border-radius: 4px;"></div>
                    <span>í°ìƒ‰íƒ€ì¼</span>
                </div>
            </div>
        </div>
        <div style="flex: 1.5; position: relative;">
            <div id="three-container" style="width:100%; height:100%;"></div>
            <!-- ì˜¤ë¥¸ìª½ ì•„ë˜: ì™„ì„± íŒ¨í„´ ë¯¸ë¦¬ë³´ê¸° -->
            <div id="pattern-preview" style="
                display: none;
                position: absolute;
                bottom: 12px;
                right: 12px;
                background: rgba(255,255,255,0.93);
                border: 2px solid #1a237e;
                border-radius: 10px;
                padding: 8px 10px;
                box-shadow: 0 2px 12px rgba(0,0,0,0.18);
                z-index: 10;
            ">
                <div style="font-size:0.7em; font-weight:bold; color:#1a237e; margin-bottom:5px; text-align:center;">ì™„ì„± íŒ¨í„´</div>
                <div id="pattern-mini-grid" style="
                    display: grid;
                    grid-template-columns: repeat(3, 20px);
                    grid-template-rows: repeat(3, 20px);
                    gap: 3px;
                "></div>
            </div>
        </div>
    </div>

    <!-- ë””ìì¸ ì„ íƒ íŒì—… -->
    <div class="popup-overlay" id="design-popup">
        <div class="popup-box">
            <h2>íƒ€ì¼ íŒ¨í„´ ì„ íƒ</h2>
            <div class="design-options">
                <!-- 1: ì§€ê·¸ì¬ê·¸ RBRB -->
                <div class="design-card" id="card-1" onclick="selectDesign(1)">
                    <div class="preview-grid" id="preview-1"></div>
                    <p>ì§€ê·¸ì¬ê·¸ â‘ </p>
                    <small>RBRB ì²´ì»¤ë³´ë“œ</small>
                </div>
                <!-- 2: ì§€ê·¸ì¬ê·¸ RRRBBB -->
                <div class="design-card" id="card-2" onclick="selectDesign(2)">
                    <div class="preview-grid" id="preview-2"></div>
                    <p>ì§€ê·¸ì¬ê·¸ â‘¡</p>
                    <small>RRR / BBB ì¤„ë¬´ëŠ¬</small>
                </div>
                <!-- 3: ë°ì½”íƒ€ì¼ -->
                <div class="design-card" id="card-3" onclick="selectDesign(3)">
                    <div class="preview-grid" id="preview-3"></div>
                    <p>ë°ì½”íƒ€ì¼</p>
                    <small>í¬ì¸íŠ¸ íŒ¨í„´</small>
                </div>
            </div>
            <button class="popup-confirm" onclick="confirmDesign()">ì„ íƒ ì™„ë£Œ</button>
            <button class="popup-cancel" onclick="closePopup()">ì·¨ì†Œ</button>
        </div>
    </div>

    <!-- ì»¤ìŠ¤í…€ íŒ¨í„´ ì…ë ¥ íŒì—… (ë°ì½”íƒ€ì¼ ì„ íƒ ì‹œ) -->
    <div class="popup-overlay" id="custom-pattern-popup">
        <div class="popup-box" style="width: 480px;">
            <h2>ğŸ¨ ì»¤ìŠ¤í…€ íŒ¨í„´ ì…ë ¥</h2>
            <p style="text-align:center; color:#555; margin-bottom: 20px;">
                ê° íƒ€ì¼ì— <strong>A</strong> (í°ìƒ‰) ë˜ëŠ” <strong>B</strong> (ê²€ì •) ë¥¼ ì…ë ¥í•˜ì„¸ìš”.<br>
                <small style="color:#999;">ìˆœì„œ: ì™¼ìª½â†’ì˜¤ë¥¸ìª½, ìœ„â†’ì•„ë˜ (9ì¹¸)</small>
            </p>

            <!-- 3x3 ì…ë ¥ ê·¸ë¦¬ë“œ -->
            <div id="custom-input-grid" style="
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
                margin-bottom: 20px;
            "></div>

            <!-- ë¯¸ë¦¬ë³´ê¸° -->
            <div style="text-align:center; margin-bottom: 16px;">
                <p style="font-weight:bold; color:#1a237e; margin-bottom: 8px;">ë¯¸ë¦¬ë³´ê¸°</p>
                <div id="custom-preview-grid" class="preview-grid" style="margin: 0 auto;"></div>
            </div>

            <button class="popup-confirm" onclick="confirmCustomPattern()">íŒ¨í„´ ì ìš©</button>
            <button class="popup-cancel" onclick="backToDesignPopup()">â† ë’¤ë¡œ</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
    let database;
    
    const firebaseConfig = {
        apiKey: "AIzaSyDPPouqUOm8Ib6blpADMf-VQ_5r9-_IyEk",
        authDomain: "co1-tiling.firebaseapp.com",
        databaseURL: "https://co1-tiling-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "co1-tiling",
        storageBucket: "co1-tiling.firebasestorage.app",
        messagingSenderId: "925424727446",
        appId: "1:925424727446:web:85cc99cd5a478fa50759b7"
    };
    
    try {
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        console.log('Firebase initialized successfully!');
    } catch(error) {
        console.error('Firebase initialization error:', error);
    }

    const TOTAL_TILES = 9; // 3x3
    const COLS = 3;
    const ROWS = 3;

    let timerInterval = null;
    let startTime = null;
    let elapsedSeconds = 0;
    let prevCompletedJobs = 0;
    let isStarted = false;
    let isEstopped = false; // ë¹„ìƒì •ì§€ ìƒíƒœ í”Œë˜ê·¸

    // ê° íƒ€ì¼ì˜ ê³ ìœ  ìƒ‰ìƒ (red/black) ì¶”ì  - nullì´ë©´ ê¸°ë³¸ ìƒíƒœìƒ‰ ì‚¬ìš©
    // íƒ€ì¼ ìƒ‰ìƒì´ ì§€ì •ë˜ë©´ ì‘ì—…ì§„í–‰ ìƒíƒœ(ë…¸ë€/ì´ˆë¡/íŒŒë€)ì™€ ë¬´ê´€í•˜ê²Œ ì´ ìƒ‰ìƒ ìœ ì§€
    const tileColors = new Array(TOTAL_TILES + 1).fill(null); // 1-indexed
    let currentDesign = 0; // í˜„ì¬ ì„ íƒëœ ë””ìì¸ (1/2/3)

    // ë””ìì¸ë³„ 3x3 íƒ€ì¼ ìƒ‰ìƒ (1-indexed, R=ë¹¨ê°• B=ê²€ì • W=í°ìƒ‰)
    const DESIGN_COLORS = {
        1: ['W','B','W','B','W','B','W','B','W'],   // WBWB ì²´ì»¤ë³´ë“œ
        2: ['W','W','W','B','B','B','W','W','W'],   // Wì¤„/Bì¤„/Wì¤„
        3: ['B','W','B','W','W','W','B','W','B'],   // ë°ì½”
    };

    function getTileColor(design, tileIdx) {
        // tileIdx: 1~9
        const pattern = DESIGN_COLORS[design];
        if (!pattern) return null;
        const c = pattern[tileIdx - 1];
        if (c === 'B') return 0x212121;
        return 0xffffff; // W = í°ìƒ‰
    }

    // -------------------------------------------------------
    // 2D íƒ€ì¼ ê·¸ë¦¬ë“œ ìƒì„± (9ì¹¸: 3í–‰ 3ì—´)
    // -------------------------------------------------------
    const tileMap = document.getElementById('tile-map');
    const activeTimers = {};
    for (let i = 1; i <= TOTAL_TILES; i++) {
        const tile = document.createElement('div');
        tile.classList.add('tile');
        tile.id = `tile-${i}`;
        tileMap.appendChild(tile);
    }

    // -------------------------------------------------------
    // Three.js 3D ì„¤ì •
    // -------------------------------------------------------
    const container = document.getElementById('three-container');
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xf0f2f5);

    const camera = new THREE.PerspectiveCamera(40, container.clientWidth / container.clientHeight, 0.1, 1000);
    camera.position.set(5, 5, 5);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 0.8));
    const light = new THREE.DirectionalLight(0xffffff, 0.5);
    light.position.set(10, 20, 10);
    scene.add(light);

    // 3D íƒ€ì¼ ìƒì„± (3x3)
    const tiles3D = [];
    const tileGeom = new THREE.BoxGeometry(0.8, 0.1, 0.8);
    const tileGap = 0.9;
    const startX = -((COLS - 1) * tileGap) / 2;
    const startZ = -((ROWS - 1) * tileGap) / 2;

    for (let i = 0; i < TOTAL_TILES; i++) {
        const mesh = new THREE.Mesh(
            tileGeom,
            new THREE.MeshStandardMaterial({ color: 0xaaaaaa })
        );
        const row = Math.floor(i / COLS);
        const col = i % COLS;
        mesh.position.set(startX + col * tileGap, 0.05, startZ + row * tileGap);
        scene.add(mesh);
        tiles3D.push(mesh);
    }

    // ë²½ ìœ„ì¹˜ ê³„ì‚°
    const tileSize = 0.8;
    const tileEndX   = startX + (COLS - 1) * tileGap + tileSize / 2;
    const tileStartX = startX - tileSize / 2;
    const tileEndZ   = startZ + (ROWS - 1) * tileGap + tileSize / 2;
    const tileStartZ = startZ - tileSize / 2;
    const padding = 0.05;

    const wallMat = new THREE.MeshStandardMaterial({ color: 0x546e7a, transparent: true, opacity: 0.7 });
    const wallThickness = 0.2;

    // ë’¤ìª½ ë²½
    const backWall = new THREE.Mesh(
        new THREE.BoxGeometry(tileEndX - tileStartX, 2.5, wallThickness),
        wallMat
    );
    backWall.position.set(
        (tileStartX + tileEndX) / 2,
        1.25,
        tileStartZ - padding - wallThickness / 2
    );
    scene.add(backWall);

    // ì™¼ìª½ ë²½
    const sideWall = new THREE.Mesh(
        new THREE.BoxGeometry(wallThickness, 2.5, tileEndZ - tileStartZ),
        wallMat
    );
    sideWall.position.set(
        tileStartX - padding - wallThickness / 2,
        1.25,
        (tileStartZ + tileEndZ) / 2
    );
    scene.add(sideWall);

    // ë°”ë‹¥ í”Œë«í¼ (íƒ€ì¼ 3x3 í¬ê¸°, ë²½ ë†’ì´ 1/3)
    const wallHeight = 2.5;
    const platformH  = wallHeight / 3;
    const platformW  = tileEndX - tileStartX;
    const platformD  = tileEndZ - tileStartZ;
    const platform = new THREE.Mesh(
        new THREE.BoxGeometry(platformW, platformH, platformD),
        new THREE.MeshStandardMaterial({ color: 0xfffff0, transparent: false })
    );
    platform.position.set(
        (tileStartX + tileEndX) / 2,
        -(platformH / 2),   // íƒ€ì¼(y=0) ë°”ë¡œ ì•„ë˜
        (tileStartZ + tileEndZ) / 2
    );
    scene.add(platform);

    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }
    animate();

    // -------------------------------------------------------
    // Firebase: robot_status ì‹¤ì‹œê°„ ìˆ˜ì‹ 
    // -------------------------------------------------------
    database.ref('robot_status').on('value', (snapshot) => {
        const data = snapshot.val();
        if (!data) return;

        // -------------------------------------------------------
        // ë¡œë´‡ì†ë„ í‘œì‹œ (Jacobian ê¸°ë°˜ TCP ì„ ì†ë„)
        // firebase_bridge.pyì—ì„œ ê´€ì ˆ ê°ë„(position) + ê°ì†ë„(velocity)ë¡œ
        // Jacobian ê³„ì‚° í›„ TCP ì„ ì†ë„(m/s)ë¥¼ Firebaseì— ì €ì¥
        // -------------------------------------------------------
        const rawJointSpeed = data.joint_speed || 0;
        const speedMps = rawJointSpeed.toFixed(3);
        document.getElementById('robot-speed').innerText = speedMps;

        document.getElementById('robot-state').innerText = data.state || "ëŒ€ê¸°";
        document.getElementById('job-count').innerText  = data.completed_jobs || 0;

        // íˆ´ ì™¸ë ¥ Fz + í•©ë ¥
        const forceZ = data.force_z !== undefined ? parseFloat(data.force_z).toFixed(2) : '0.00';
        const forceTotal = data.force_total !== undefined ? parseFloat(data.force_total).toFixed(2) : '0.00';
        document.getElementById('force-z').innerText     = forceZ;
        document.getElementById('force-total').innerText = forceTotal;

        // ê´€ì ˆ ì™¸ë¶€í† í¬
        if (data.ext_torque) {
            const t = data.ext_torque;
            document.getElementById('ext-torque-display').innerHTML =
                `J1: ${(t['0']||0).toFixed(2)} &nbsp; J2: ${(t['1']||0).toFixed(2)} &nbsp; J3: ${(t['2']||0).toFixed(2)} &nbsp; J4: ${(t['3']||0).toFixed(2)} &nbsp; J5: ${(t['4']||0).toFixed(2)} &nbsp; J6: ${(t['5']||0).toFixed(2)}`;
        }

        // ì¶©ëŒ ê°ì§€ â†’ ìë™ ë¹„ìƒì •ì§€ ì˜¤ë²„ë ˆì´ (ì¬ê°œ ë¶ˆê°€, ì´ˆê¸°í™”ë§Œ ê°€ëŠ¥)
        if (data.state && data.state.includes('ì¶©ëŒ ê°ì§€')) {
            const overlay = document.getElementById('estop-overlay');
            if (overlay.style.display !== 'flex') {
                overlay.style.display = 'flex';
                isEstopped = true; // ì¶©ëŒ ê°ì§€ ì‹œì—ë„ í”Œë˜ê·¸ ON
                pauseTimer();
            }
            const resumeBtn = document.getElementById('resume-btn');
            // ì™¸ë ¥ ê°ì§€ì‹œ ì¬ê°œë²„íŠ¼ ìˆ¨ê¸°ë ¤ë©´ none ë³´ì´ë ¤ë©´ ''
            if (resumeBtn) resumeBtn.style.display = '';
            const info = document.getElementById('collision-info');
            if (data.collision_joint !== undefined && data.collision_torque !== undefined) {
                info.style.display = 'block';
                if (data.collision_joint === 0) {
                    info.innerText = `âš  TCP í•©ë ¥ ${parseFloat(data.collision_torque).toFixed(2)} N ì´ˆê³¼`;
                } else if (data.collision_joint === -1) {
                    info.innerText = `âš  TCP Fz ${parseFloat(data.collision_torque).toFixed(2)} N ì´ˆê³¼`;
                } else {
                    info.innerText = `âš  J${data.collision_joint} ê´€ì ˆ ì™¸ë¶€í† í¬ ${parseFloat(data.collision_torque).toFixed(2)} Nm ì´ˆê³¼`;
                }
            }
            const resetGuide = document.getElementById('collision-reset-guide');
            if (resetGuide) resetGuide.style.display = 'block';
        }

        const currentStep = data.current_step || 0;
        updateProcessStep(currentStep);

        // design ë²ˆí˜¸ ì—…ë°ì´íŠ¸
        if (data.design) currentDesign = parseInt(data.design);

        if (!isStarted) return;
        if (isEstopped) return; // ë¹„ìƒì •ì§€ ì¤‘ì—ëŠ” íƒ€ì¼ ìƒíƒœ ë³€ê²½ ì°¨ë‹¨

        const currentJobs = data.completed_jobs || 0;

        // í˜„ì¬ ì‘ì—… ì¤‘ì¸ íƒ€ì¼ ì¸ë±ìŠ¤ (ì™„ë£Œëœ ê²ƒ ë‹¤ìŒ)
        const workingTileIdx = currentJobs; // 0~8

        if (currentStep === 1) {
            // Step1: ì™„ë£Œ/ë§ˆë¥´ëŠ”ì¤‘ íƒ€ì¼ ì œì™¸í•˜ê³  ì „ë¶€ ë¹ˆ ìƒíƒœ
            for (let i = 1; i <= TOTAL_TILES; i++) {
                const el = document.getElementById(`tile-${i}`);
                if (el && !el.classList.contains('finished') && !el.classList.contains('running')) {
                    el.classList.remove('working', 'coated');
                    el.innerText = '';
                }
            }
        } else if (currentStep === 2) {
            // Step2: 9ê°œ ì „ë¶€ í•œêº¼ë²ˆì— íšŒìƒ‰(coated)ìœ¼ë¡œ í‘œì‹œ
            for (let i = 1; i <= TOTAL_TILES; i++) {
                const el = document.getElementById(`tile-${i}`);
                if (!el || el.classList.contains('finished') || el.classList.contains('running')) continue;
                el.classList.remove('working');
                el.classList.add('coated');
                el.innerText = '';
            }
        } else if (currentStep === 3) {
            // Step3: workingTileIdx+1ë²ˆ íƒ€ì¼ (1~9 ìˆœì„œ) ë…¸ë€ìƒ‰ "ì‘ì—…ì¤‘"
            const workingTileId = workingTileIdx + 1; // 1~9
            if (workingTileId <= TOTAL_TILES) {
                const el = document.getElementById(`tile-${workingTileId}`);
                if (el && !el.classList.contains('finished') && !el.classList.contains('running')) {
                    el.classList.remove('coated');
                    el.classList.add('working');
                    el.innerText = 'ì‘ì—…ì¤‘';
                }
            }
        }
        // Step4: ë³„ë„ ì²˜ë¦¬ ì—†ìŒ (completed_jobs ì¦ê°€ë¡œ ì²˜ë¦¬)

        // â”€â”€ completed_jobs ì¦ê°€ ì²˜ë¦¬ (Step4 ì™„ë£Œ â†’ ì´ˆë¡ìƒ‰) â”€â”€â”€
        if (currentJobs > prevCompletedJobs) {
            for (let i = prevCompletedJobs + 1; i <= currentJobs; i++) {
                // ì™„ë£Œëœ íƒ€ì¼ì— ë””ìì¸ ìƒ‰ìƒ ì ìš© (3D)
                const color = getTileColor(currentDesign, i);
                if (color !== null) {
                    tileColors[i] = color;
                    tiles3D[i - 1].material.color.setHex(color);
                } else {
                    tiles3D[i - 1].material.color.setHex(0xffffff);
                }
                // 2D: working â†’ running(ì´ˆë¡, ë§ˆë¥´ëŠ”ì¤‘) ìœ¼ë¡œ ì „í™˜ í›„ íƒ€ì´ë¨¸
                startTileTimer(i, 120);
            }
        }

        prevCompletedJobs = currentJobs;
    });

    // -------------------------------------------------------
    // ê³µì • ë‹¨ê³„ ì—…ë°ì´íŠ¸
    // -------------------------------------------------------
    function updateProcessStep(stepNumber) {
        for (let i = 1; i <= 4; i++) {
            const el = document.getElementById('step' + i);
            if (el) el.classList.remove('active');
        }
        if (stepNumber > 0 && stepNumber <= 4) {
            const el = document.getElementById('step' + stepNumber);
            if (el) el.classList.add('active');
        }
    }


    // -------------------------------------------------------
    // ë””ìì¸ ì„ íƒ íŒì—…
    // -------------------------------------------------------
    // 3x3 íŒ¨í„´ ì •ì˜ (B=ê²€ì •, W=í°ìƒ‰)
    const PATTERNS = {
        1: ['W','B','W', 'B','W','B', 'W','B','W'],   // WBWB ì²´ì»¤ë³´ë“œ
        2: ['W','W','W', 'B','B','B', 'W','W','W'],   // Wì¤„/Bì¤„/Wì¤„
        3: ['B','W','B', 'W','W','W', 'B','W','B'],   // ë°ì½”: í…Œë‘ë¦¬ê²€ì •+ì¤‘ì•™í°ìƒ‰
    };

    let selectedDesign = null;

    function buildPreviews() {
        [1, 2, 3].forEach(id => {
            const grid = document.getElementById('preview-' + id);
            grid.innerHTML = '';
            PATTERNS[id].forEach(c => {
                const cell = document.createElement('div');
                cell.className = 'preview-cell ' +
                    (c === 'B' ? 'pc-black' : '');
                grid.appendChild(cell);
            });
        });
    }
    buildPreviews();

    // -------------------------------------------------------
    // ì™„ì„± íŒ¨í„´ ë¯¸ë¦¬ë³´ê¸° (3D ë·° ì˜¤ë¥¸ìª½ ì•„ë˜)
    // -------------------------------------------------------
    const patternMiniGrid = document.getElementById('pattern-mini-grid');
    for (let i = 0; i < 9; i++) {
        const cell = document.createElement('div');
        cell.id = 'pmini-' + i;
        cell.style.cssText = 'width:20px; height:20px; border-radius:3px; border:1px solid #ccc; background:#e0e0e0;';
        patternMiniGrid.appendChild(cell);
    }

    function showPatternPreview(design) {
        const pattern = PATTERNS[design];
        if (!pattern) return;
        for (let i = 0; i < 9; i++) {
            const cell = document.getElementById('pmini-' + i);
            if (!cell) continue;
            if (pattern[i] === 'B') {
                cell.style.background = '#212121';
                cell.style.border = '1px solid #000';
            } else {
                cell.style.background = '#ffffff';
                cell.style.border = '1px solid #bbb';
            }
        }
        document.getElementById('pattern-preview').style.display = 'block';
    }

    function showCustomPatternPreview(values) {
        // values: ['A','B','A',...] A=í° B=ê²€
        for (let i = 0; i < 9; i++) {
            const cell = document.getElementById('pmini-' + i);
            if (!cell) continue;
            if (values[i] === 'B') {
                cell.style.background = '#212121';
                cell.style.border = '1px solid #000';
            } else {
                cell.style.background = '#ffffff';
                cell.style.border = '1px solid #bbb';
            }
        }
        document.getElementById('pattern-preview').style.display = 'block';
    }

    function hidePatternPreview() {
        document.getElementById('pattern-preview').style.display = 'none';
    }

    function openDesignPopup() {
        selectedDesign = null;
        [1,2,3].forEach(i => document.getElementById('card-'+i).classList.remove('selected'));
        document.getElementById('design-popup').classList.add('show');
    }

    function closePopup() {
        document.getElementById('design-popup').classList.remove('show');
        document.getElementById('custom-pattern-popup').classList.remove('show');
    }

    function selectDesign(n) {
        selectedDesign = n;
        [1,2,3].forEach(i => document.getElementById('card-'+i).classList.remove('selected'));
        document.getElementById('card-'+n).classList.add('selected');
    }

    function confirmDesign() {
        if (!selectedDesign) { alert('íŒ¨í„´ì„ ì„ íƒí•´ì£¼ì„¸ìš”!'); return; }

        // design 3: ì»¤ìŠ¤í…€ íŒ¨í„´ ì…ë ¥ íŒì—…ìœ¼ë¡œ ì „í™˜
        if (selectedDesign === 3) {
            document.getElementById('design-popup').classList.remove('show');
            openCustomPatternPopup();
            return;
        }

        closePopup();
        // robot_commandì— action + design ë²ˆí˜¸ í•¨ê»˜ ì „ì†¡ (ìµœì´ˆ ì‹œì‘)
        database.ref('robot_command').set({ action: 'start', design: selectedDesign, is_resume: false, timestamp: Date.now() });
        // ê¸°ì¡´ start ë¡œì§
        isStarted = true;
        showPatternPreview(selectedDesign);
        if (!timerInterval) startTimer();
    }

    // â”€â”€ ì»¤ìŠ¤í…€ íŒ¨í„´ íŒì—… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const customValues = new Array(9).fill('A'); // ê¸°ë³¸ê°’ A

    function openCustomPatternPopup() {
        // íŒì—…ì„ ì—´ ë•Œë§ˆë‹¤ í•­ìƒ Aë¡œ ì´ˆê¸°í™”
        customValues.fill('A');

        const grid = document.getElementById('custom-input-grid');
        grid.innerHTML = '';
        for (let i = 0; i < 9; i++) {
            const wrapper = document.createElement('div');
            wrapper.style.cssText = 'display:flex; flex-direction:column; align-items:center; gap:6px;';

            const label = document.createElement('div');
            label.style.cssText = 'font-size:0.8em; color:#888;';
            label.innerText = `íƒ€ì¼ ${i+1}`;

            const btn = document.createElement('button');
            btn.id = `custom-btn-${i}`;
            btn.style.cssText = `
                width: 60px; height: 60px; font-size: 1.4em; font-weight: bold;
                border-radius: 10px; cursor: pointer; border: 3px solid;
                transition: 0.2s; flex: unset; padding: 0;
            `;
            btn.innerText = customValues[i];
            applyCustomBtnStyle(btn, customValues[i]);

            btn.onclick = () => {
                customValues[i] = customValues[i] === 'A' ? 'B' : 'A';
                btn.innerText = customValues[i];
                applyCustomBtnStyle(btn, customValues[i]);
                updateCustomPreview();
            };

            wrapper.appendChild(label);
            wrapper.appendChild(btn);
            grid.appendChild(wrapper);
        }
        updateCustomPreview();
        document.getElementById('custom-pattern-popup').classList.add('show');
    }

    function applyCustomBtnStyle(btn, val) {
        if (val === 'A') {
            btn.style.background = '#ffffff';
            btn.style.color = '#333';
            btn.style.borderColor = '#aaa';
        } else {
            btn.style.background = '#212121';
            btn.style.color = '#fff';
            btn.style.borderColor = '#000';
        }
    }

    function updateCustomPreview() {
        const pg = document.getElementById('custom-preview-grid');
        pg.innerHTML = '';
        customValues.forEach(v => {
            const cell = document.createElement('div');
            cell.className = 'preview-cell ' + (v === 'A' ? 'pc-black' : '');
            pg.appendChild(cell);
        });
    }

    function confirmCustomPattern() {
        // A=ê²€ì • B=í°ìƒ‰ â†’ firebase_bridgeê°€ /robot/design_abì— publish
        const patternStr = customValues.join(','); // ì˜ˆ: "A,B,A,B,A,B,A,B,A"
        closePopup();

        database.ref('robot_command').set({
            action: 'start',
            design: 3,
            custom_pattern: patternStr,
            is_resume: false,
            timestamp: Date.now()
        });

        // DESIGN_COLORSì— ì»¤ìŠ¤í…€ íŒ¨í„´ ë°˜ì˜ (3D/2D ìƒ‰ìƒìš©)
        DESIGN_COLORS[3] = customValues.map(v => v === 'B' ? 'W' : 'B');

        isStarted = true;
        showCustomPatternPreview(customValues);
        if (!timerInterval) startTimer();
    }

    function backToDesignPopup() {
        document.getElementById('custom-pattern-popup').classList.remove('show');
        document.getElementById('design-popup').classList.add('show');
    }

    window.openDesignPopup = openDesignPopup;
    window.closePopup = closePopup;
    window.selectDesign = selectDesign;
    window.confirmDesign = confirmDesign;
    window.confirmCustomPattern = confirmCustomPattern;
    window.backToDesignPopup = backToDesignPopup;

    // -------------------------------------------------------
    // ë²„íŠ¼ ì»¤ë§¨ë“œ
    // -------------------------------------------------------
    function sendCommand(cmd) {
        database.ref('robot_command').set({ action: cmd, timestamp: Date.now() });

        if (cmd === 'start') {
            isStarted = true;
            if (!timerInterval) startTimer();
        } else if (cmd === 'stop') {
            pauseTimer();
            isEstopped = true; // ë¹„ìƒì •ì§€ í”Œë˜ê·¸ ON
            // ë¹„ìƒì •ì§€ ì˜¤ë²„ë ˆì´ í‘œì‹œ
            const overlay = document.getElementById('estop-overlay');
            overlay.style.display = 'flex';
        }
    }
    window.sendCommand = sendCommand;

    function resumeRobot() {
        // Firebaseì—ì„œ í˜„ì¬ stepê³¼ completed_jobsë¥¼ ì½ì–´ì„œ í•¨ê»˜ ì „ì†¡
        database.ref('robot_status').once('value', (snapshot) => {
            const status = snapshot.val() || {};
            const currentStep    = status.current_step    || 0;
            const completedJobs  = status.completed_jobs  || 0;

            database.ref('robot_command').set({
                action:         'resume',
                current_step:   currentStep,
                completed_jobs: completedJobs,
                timestamp:      Date.now()
            });
        });

        document.getElementById('estop-overlay').style.display = 'none';
        const info = document.getElementById('collision-info');
        info.style.display = 'none';
        info.innerText = '';
        isEstopped = false; // ë¹„ìƒì •ì§€ í”Œë˜ê·¸ OFF â†’ íƒ€ì¼ ìƒíƒœ ì—…ë°ì´íŠ¸ ì¬ê°œ
        startTimer();
    }
    window.resumeRobot = resumeRobot;

    // -------------------------------------------------------
    // íƒ€ì´ë¨¸
    // -------------------------------------------------------
    function startTimer() {
        if (timerInterval) return;
        startTime = Date.now() - (elapsedSeconds * 1000);
        timerInterval = setInterval(() => {
            elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
            updateTimerDisplay();
        }, 1000);
    }

    function updateTimerDisplay() {
        const h = Math.floor(elapsedSeconds / 3600);
        const m = Math.floor((elapsedSeconds % 3600) / 60);
        const s = elapsedSeconds % 60;
        document.getElementById('timer').innerText =
            `${String(h).padStart(2,'0')} : ${String(m).padStart(2,'0')} : ${String(s).padStart(2,'0')}`;
    }

    function pauseTimer() {
        if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
    }

    // -------------------------------------------------------
    // ì´ˆê¸°í™”
    // -------------------------------------------------------
    function resetSystem() {
        // 1. ë¡œì»¬ ìƒíƒœ ë¨¼ì € ì™„ì „ ì´ˆê¸°í™” (Firebase ë¦¬ìŠ¤ë„ˆ ë°œë™ ì „ì—)
        pauseTimer();
        startTime = null;
        elapsedSeconds = 0;
        isStarted = false;
        isEstopped = false; // ë¹„ìƒì •ì§€ í”Œë˜ê·¸ ì´ˆê¸°í™”
        prevCompletedJobs = 0;
        currentDesign = 0;
        document.getElementById('timer').innerText = '00 : 00 : 00';

        // 2. íƒ€ì´ë¨¸ ì „ë¶€ ì •ì§€
        for (let id in activeTimers) clearInterval(activeTimers[id]);
        Object.keys(activeTimers).forEach(key => delete activeTimers[key]);

        // ë¹„ìƒì •ì§€ ì˜¤ë²„ë ˆì´ ì´ˆê¸°í™”
        document.getElementById('estop-overlay').style.display = 'none';
        // ì¶©ëŒ ê´€ë ¨ ìš”ì†Œ ì´ˆê¸°í™”
        const resumeBtn = document.getElementById('resume-btn');
        if (resumeBtn) resumeBtn.style.display = '';
        const collisionInfo = document.getElementById('collision-info');
        if (collisionInfo) { collisionInfo.style.display = 'none'; collisionInfo.innerText = ''; }
        const collisionGuide = document.getElementById('collision-reset-guide');
        if (collisionGuide) collisionGuide.style.display = 'none';

        // 3. 2D íƒ€ì¼ UI ì´ˆê¸°í™”
        for (let i = 1; i <= TOTAL_TILES; i++) {
            tileColors[i] = null;
            const el = document.getElementById(`tile-${i}`);
            if (el) { el.classList.remove('working', 'coated', 'running', 'finished'); el.innerText = ''; }
        }

        // 4. 3D íƒ€ì¼ ì´ˆê¸°í™”
        tiles3D.forEach(mesh => mesh.material.color.setHex(0xaaaaaa));
        updateProcessStep(0);
        hidePatternPreview();

        // 5. Firebase ì—…ë°ì´íŠ¸ (ë§ˆì§€ë§‰ì— - ë¦¬ìŠ¤ë„ˆ ë°œë™í•´ë„ isStarted=falseë¼ ë¬´ì‹œë¨)
        database.ref('robot_status').update({
            completed_jobs: 0,
            working_tile: 0,
            current_step: 0,
            speed: 0,
            state: 'ëŒ€ê¸°',
            design: 0
        });
        database.ref('robot_command').set({ action: 'reset', timestamp: Date.now() });

        console.log('System reset completed!');
    }
    window.resetSystem = resetSystem;

    // -------------------------------------------------------
    // íƒ€ì¼ íƒ€ì´ë¨¸ (ë§ˆë¥´ëŠ” ì¤‘ â†’ ì™„ë£Œ)
    // -------------------------------------------------------
    function startTileTimer(id, sec) {
        let left = sec;
        const el = document.getElementById(`tile-${id}`);
        const mesh = tiles3D[id - 1];
        if (!el || el.classList.contains('finished')) return;

        el.classList.remove('working', 'coated');
        el.classList.add('running');

        activeTimers[id] = setInterval(() => {
            left--;
            const m = Math.floor(left / 60);
            const s = left % 60;
            el.innerText = `${m}:${s < 10 ? '0' + s : s}`;

            if (left <= 0) {
                clearInterval(activeTimers[id]);
                el.innerText = "ì™„ë£Œ";
                el.classList.remove('running');
                el.classList.add('finished');
            }
        }, 1000);
    }

    window.addEventListener('resize', () => {
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
    });
</script>
</body>
</html>